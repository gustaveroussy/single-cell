Materials and Methods


QC reads, Pseudo-mapping and quantification
Raw BCL-files were demultiplexed and converted to Fastq format using bcl2fastq (version 2.20.0.422 from Illumina).Reads quality control was performed using fastqc (version 0.11.9) and assignment to the expected genome species evaluated with fastq-screen (version 0.14.0).Reads were pseudo-mapped to the Ensembl reference transcriptome v99 corresponding to the homo sapiens GRCH38 build with kallisto (version 0.46.2) using its 'bus' subcommand and parameters corresponding to the 10X Chromium 5' scRNA-Seq v2 chemistry. The index was made with the kb-python (version 0.24.4) wrapper of kallisto. Barcode correction using whitelist provided by the manufacturer (10X Genomics) and gene-based reads quantification was performed with BUStools (version 0.40.0).

QC data on each sample
Cell barcode by symbol count table were loaded in R (version 4.0.4) using the BUSpaRse package (version 1.5.3).
To call real cells from empty droplets, we used the emptyDrops() function from the dropletUtils (version 1.10.3) package, which assesses whether the RNA content associated with a cell barcode is significantly distinct from the ambient background RNA present within each sample. Barcodes with p-value < 0.001 (Benjamini-Hochberg-corrected) were considered as legitimate cells for further analysis.
The count matrix was filtered to exclude genes detected in less than 5 cells, cells with less than 1000 UMIs or less than 200 detected genes, as well as cells with mitochondrial transcripts proportion higher than 15%.The proportion of ribosomal gene counts and the proportion of mechanical stress-response gene counts (Thesis of Léo Machado entitled « From skeletal muscle stem cells to tissue atlases: new tools to investigate and circumvent dissociation-induced stress», 2019) were also estimated but not used to filter cells.Cell cycle scoring of each cell was performed using two methods: the CellcycleScoring() function from the Seurat package (version 4.0.0), and the cyclone() function from Scran (version 1.18.5).

Barcodes corresponding to doublet cells were identified and discarded using the union of two methods: scDblFinder (version 1.4.0) using default parameters, and scds (version 1.6.0) with its hybrid method using default parameters. We manualy verified that the cells identified as doublets did not systematically correspond to cells in G2M phase.

Individual analysis
Seurat (version 4.0.0) was applied for further data processing. The SCTransform normalization method (Hafemeister C, Satija R. Normalization and variance stabilization of single-cell RNA-seq data using regularized negative binomial regression. Genome Biol. 2019;20 10.1186/s13059-019-1874-1.) was used to normalize, scale, select 3000 Highly Variable Genes.The number of PCA dimensions to keep for further analysis was evaluated by assessing a range of reduced PCA spaces using 3 to 49 dimensions, with a step of 2. For each generated PCA space, Louvain clustering of cells was performed using a range of values for the resolution parameter from 0.1 to 1.2 with a step of 0.1. The optimal space was manually evaluated as the one combination of kept dimensions and clustering resolution resolving the best structure (clusters homogeneity and compacity) in a Uniform Manifold Approximation and Projection space (UMAP). Additionaly, we used the clustree method (version 0.4.3) to assess if the selected optimal space corresponded to a relatively stable position in the clustering results tested for these dimensions / resolution combinations.
An automatic annotation of cell types was perfom by SingleR (version 1.4.1) (with fine-tuning step) and ClustifyR (version 1.3.3), using packages built-in references. It labels clusters (or cells) from a dataset based on similarity (Spearman correlation score) to a reference dataset with known labels. The labels with a correlation score greater than 0.25 for SingleR or greater than 0.35 for ClustifyR were kept.Marker genes for Louvain clusters were identified through a «one versus others» differential anaylisis using the Wilcoxon test through the FindAllMarkers() function from Seurat, considering only genes with a minimum log fold-change of 0.5 in at least 75% of cells from one of the groups compared, and FDR-adjusted p-values <0.05 (Benjaminin-Hochberg method).

Cell surface proteins (CITE-seq ADT)
Raw BCL-files were demultiplexed and converted to Fastq format using bcl2fastq (version 2.20.0.422 from Illumina).Reads quality control was performed using fastqc (version 0.11.9) and assignment to the expected genome species evaluated with fastq-screen (version 0.14.0).A customized index, with the correspondance between synthetic DNA-transcripts and tagged protein names, was made with the kb-python (version 0.24.4) wrapper of kallisto. Reads were pseudo-mapped to the customized index with kallisto (version 0.46.2) using its 'bus' subcommand and parameters corresponding to the 10X Chromium 5' scRNA-Seq v2 chemistry. Barcode correction using whitelist provided by the manufacturer (10X Genomics) and gene-based reads quantification was performed with BUStools (version 0.40.0). Only cell barcodes corresponding to the cell barcodes of gene expression were kept. Counting table was log-normalize (NormalizeData() function from Seurat with normalization.method parameters setting to 'LogNormalize') and spearman correlation scores beetween protein levels and gene expression levels was computed and ploted on UMAP.

Cell surface proteins (CITE-seq ADT)
Raw BCL-files were demultiplexed and converted to Fastq format using bcl2fastq (version 2.20.0.422 from Illumina).Reads quality control was performed using fastqc (version 0.11.9) and assignment to the expected genome species evaluated with fastq-screen (version 0.14.0).CellRanger (version 3.1.0 from 10X Genomics) was used to generate single-cell V(D)J sequences and annotations.

Single-cell immune profiling (TCR)
 The annotation was merged with corresponding cell barcode of 5’ gene expression. The scRepertoire package (version 1.1.2) was used to process annotation to assign clonotype based on TCR chains. scRepertoire allows to study contig quantification, contig abundance, contig length, clonal space homeostasis, clonal proportion, clonal overlap beetween clusters and diversity. Physicochemical properties of the CDR3, based on amino-acid sequences, was determined by the alakazam R package (version 1.1.0).

Single-cell immune profiling (Ig)
 The annotation was merged with corresponding cell barcode of 5’ gene expression. The scRepertoire package (version 1.1.2) was used to process annotation to assign clonotype based on Ig chains. scRepertoire allows to study contig quantification, contig abundance, contig length, clonal space homeostasis, clonal proportion, clonal overlap beetween clusters and diversity. Physicochemical properties of the CDR3, based on amino-acid sequences, was determined by the alakazam R package (version 1.1.0).

Cerebro
Cerebro (version 1.3.1), cell report browser, is an AppShiny which allows users to interactively visualize various parts of single cell transcriptomics analysis without requiring bioinformatics expertise. This package is also used to identify most expressed genes, and to compute pathway enrichment on marker genes (based on the Enrichr API) and Gene Set Enrichment Analysis (uses the Gene Set Variation Analysis method in combination with additional statistics as published by Diaz-Mejia et. al.(Diaz-Mejia JJ, Meng EC, Pico AR et al. Evaluation of methods to assign cell type labels to cell clusters from single-cell RNA-sequencing data [version 3; peer review: 2 approved, 1 approved with reservations]. F1000Research 2019, 8(ISCB Comm J):296 (https://doi.org/10.12688/f1000research.18490.3))) from the MSigDB (H collection: hallmark gene sets).

References of tools
alakazam : Gupta N, Vander Heiden J, Uduman M, Gadala-Maria D, Yaari G, Kleinstein S (2015). Change-O: a toolkit for analyzing large-scale B cell immunoglobulin repertoire sequencing data. Bioinformatics, 1-3. doi: 10.1093/bioinformatics/btv359 (URL: https://doi.org/10.1093/bioinformatics/btv359).
BUSpaRse : Moses L, Pachter L (2020). BUSpaRse: kallisto | bustools R utilities. R package version 1.4.1, https://github.com/BUStools/BUSpaRse
BUStools : Pall Melsted, Vasilis Ntranos, Lior Pachter, The barcode, UMI, set format and BUStools, Bioinformatics, Volume 35, Issue 21, 1 November 2019, Pages 4472-4473, https://doi.org/10.1093/bioinformatics/btz279
Cerebro : Roman Hillje, Pier Giuseppe Pelicci, Lucilla Luzi, Cerebro: interactive visualization of scRNA-seq data, Bioinformatics, Volume 36, Issue 7, 1 April 2020, Pages 2311-2313, https://doi.org/10.1093/bioinformatics/btz877
ClustifyR : Fu R, Gillen A, Sheridan RM, Tian C, Daya M, Hao Y, Hesselberth JR, Riemondy KA (2019). clustifyr: An R package for automated single-cell RNA sequencing clusters classification. _F1000 Research_. doi:10.12688/f1000research.22969.1 (URL:https://doi.org/10.12688/f1000research.22969.1
clustree : Zappia L, Oshlack A. Clustering trees: a visualization for evaluating clusterings at multiple resolutions. GigaScience. 2018;7.DOI:gigascience/giy083.
dropletUtils : Lun ATL, Riesenfeld S, Andrews T, Dao T, Gomes T, participants in the 1st Human Cell Atlas Jamboree, Marioni JC (2019). EmptyDrops: distinguishing cells from empty droplets in droplet-based single-cell RNA sequencing data. Genome Biol., 20, 63. doi: 10.1186/s13059-019-1662-y. 
Griffiths JA, Richard AC, Bach K, Lun ATL, Marioni JC (2018). Detection and removal of barcode swapping in single-cell RNA-seq data. Nat. Commun., 9(1), 2667. doi: 10.1038/s41467-018-05083-x.
fastq-screen : Wingett SW and Andrews S. FastQ Screen: A tool for multi-genome mapping and quality control [version 2; referees: 4 approved]. F1000Research 2018, 7:1338 (https://doi.org/10.12688/f1000research.15931.2)
kallisto : Nicolas L Bray, Harold Pimentel, Pall Melsted and Lior Pachter, Near-optimal probabilistic RNA-seq quantification, Nature Biotechnology 34, 525-527 (2016), doi:10.1038/nbt.3519
kb-python : Bray, N. L., Pimentel, H., Melsted, P., & Pachter, L. (2016). Near-optimal probabilistic RNA-seq quantification. Nature biotechnology, 34(5), 525 ; Melsted, P., Booeshaghi, A. S., Gao, F., da Veiga Beltrame, E., Lu, L., Hjorleifsson, K. E., Gehring, J., & Pachter, L. (2019). Modular and efficient pre-processing of single-cell RNA-seq. BioRxiv, 673285.
scDblFinder : Germain P (2020). scDblFinder: scDblFinder. R package version 1.4.0, https://github.com/plger/scDblFinder
scds : Bais AS, Kostka D. scds: computational annotation of doublets in single-cell RNA sequencing data. Bioinformatics. 2020 Feb 15;36(4):1150-1158. doi: 10.1093/bioinformatics/btz698. PMID: 31501871; PMCID: PMC7703774
Scran : Lun ATL, McCarthy DJ, Marioni JC (2016). A step-by-step workflow for low-level analysis of single-cell RNA-seq data with Bioconductor. F1000Res., 5, 2122. doi: 10.12688/f1000research.9501.2
scRepertoire : Borcherding N and Bormann NL. scRepertoire: An R-based toolkit for single-cell immune receptor analysis [version 1; peer review: 2 approved with reservations]. F1000Research 2020, 9:47 (https://doi.org/10.12688/f1000research.22139.1)
Seurat : Butler, A., Hoffman, P., Smibert, P., Papalexi, E. & Satija, R. Integrating single-cell transcriptomic data across different conditions, technologies, and species. Nat. Biotechnol. 36, 411-420 (2018)
SingleR : Aran, Looney, Liu et al. Reference-based analysis of lung single-cell sequencing reveals a transitional profibrotic macrophage. Nature Immunology (2019)
